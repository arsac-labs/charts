---
name: Check Upstream Releases

on:
  schedule:
    # Run daily at 6am UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  check-agent-sandbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          version=$(grep '^appVersion:' charts/agent-sandbox/Chart.yaml | sed 's/appVersion: *"\(.*\)"/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest upstream version
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version=$(gh release view --repo kubernetes-sigs/agent-sandbox --json tagName -q '.tagName')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Trigger update if newer
        if: steps.current.outputs.version != steps.upstream.outputs.version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Current: ${{ steps.current.outputs.version }}"
          echo "Upstream: ${{ steps.upstream.outputs.version }}"
          gh workflow run update-agent-sandbox.yaml -f version=${{ steps.upstream.outputs.version }}
